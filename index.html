<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>GPS＋IMU シンプル実験版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: -apple-system, system-ui; padding: 1.5rem; }
    .card { padding: 1rem; margin: 1rem 0; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .value { font-size: 2rem; font-weight: bold; }
    button { padding: 0.7rem 1.2rem; margin-right: 0.5rem; border-radius: 999px; font-size: 1rem; border: none; }
    #start { background: #007aff; color: white; }
    #stop  { background: #e5e5ea; color: black; }
  </style>
</head>
<body>

<h1>GPS ≥ 1.0 m/s & IMU ピークでカウント</h1>

<div class="card">
  <div>カウント</div>
  <div class="value" id="count">0</div>
</div>

<div class="card">
  <div>現在の速度 (m/s)</div>
  <div class="value" id="speed">0</div>
</div>

<p>
  <button id="start">計測開始</button>
  <button id="stop">停止</button>
</p>

<script>
let running = false;
let count = 0;
let currentSpeed = 0;
let gpsWatchId = null;

// しきい値（必要ならここだけ調整）
const SPEED_MIN = 1.0;      // m/s 以上で移動中と判定
const IMU_MIN = 1.2;        // dynMag のピークしきい値
let lastPeak = 0;
const PEAK_INTERVAL = 300;  // 最短ピーク間隔 (ms)

// 位置情報（速度計算）
function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

let lastPos = null;

function handlePosition(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const t = pos.timestamp;

  if (lastPos) {
    const d = distanceMeters(lastPos.lat, lastPos.lon, lat, lon);
    const dt = (t - lastPos.t) / 1000;
    if (dt > 0.4) currentSpeed = d / dt; // m/s
  }
  lastPos = { lat, lon, t };
  document.getElementById('speed').textContent = currentSpeed.toFixed(2);
}

// IMU ピーク検知
function handleMotion(e) {
  if (!running || !e.accelerationIncludingGravity) return;

  const ag = e.accelerationIncludingGravity;
  const ax = ag.x || 0, ay = ag.y || 0, az = ag.z || 0;

  // 全加速度量 - 重力 → 簡易ピーク
  const mag = Math.sqrt(ax*ax + ay*ay + az*az);
  const dyn = Math.abs(mag - 9.8);

  const now = Date.now();

  if (dyn > IMU_MIN && (now - lastPeak) > PEAK_INTERVAL) {

    // ※ GPS 速度が一定以上のときだけカウント
    if (currentSpeed >= SPEED_MIN) {
      count++;
      document.getElementById('count').textContent = count;
    }

    lastPeak = now;
  }
}

// start / stop
document.getElementById('start').onclick = () => {
  if (running) return;
  running = true;

  count = 0;
  document.getElementById('count').textContent = 0;
  lastPeak = 0;

  // motion permission
  if (typeof DeviceMotionEvent?.requestPermission === 'function') {
    DeviceMotionEvent.requestPermission().then(r => {
      if (r === 'granted') window.addEventListener('devicemotion', handleMotion);
    });
  } else {
    window.addEventListener('devicemotion', handleMotion);
  }

  // GPS watch
  gpsWatchId = navigator.geolocation.watchPosition(handlePosition, console.error, {
    enableHighAccuracy: true,
    maximumAge: 1000,
    timeout: 10000
  });
};

document.getElementById('stop').onclick = () => {
  running = false;
  window.removeEventListener('devicemotion', handleMotion);
  if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
};
</script>
</body>
</html>
